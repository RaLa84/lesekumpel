<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deine Geschichte</title>
    <style>
        /* --- GRUNDLAGEN --- */
        body { font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; background-color: #f0f8ff; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: #ffffff; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 5px solid #ffcc00; }

        /* --- TOOLBAR --- */
        .toolbar { background-color: #fff9e6; border-radius: 15px; padding: 10px; margin-bottom: 30px; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; border: 2px dashed #ffcc00; }
        .tool-btn { background: white; border: 2px solid #ffcc00; border-radius: 10px; padding: 10px 15px; cursor: pointer; font-family: inherit; font-weight: bold; font-size: 16px; color: #555; display: flex; align-items: center; gap: 5px; transition: all 0.1s; user-select: none; -webkit-tap-highlight-color: transparent; }
        .tool-btn:hover { background-color: #ff6b6b; border-color: #ff6b6b; color: white; transform: translateY(-2px); }
        .tool-btn.active { background-color: #ffcc00; color: #333; border-color: #e6b800; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }

        /* --- LUPE STYLES --- */
        .interactive-word {
            display: inline; /* Wichtig: Inline lassen, damit der Textfluss stimmt */
            border-radius: 3px;
            transition: background 0.1s;
        }

        /* Nur wenn Lupe AN ist */
        .magnify-mode .interactive-word { cursor: pointer; }
        .magnify-mode .interactive-word:hover { background-color: rgba(255, 204, 0, 0.3); color: #d32f2f; }

        /* Das aktive Wort beim Vorlesen */
        .word-reading {
            background-color: #ffcc00 !important;
            color: #d32f2f !important;
            box-shadow: 0 0 0 2px #ffcc00; /* Rahmen trick */
            border-radius: 4px;
            z-index: 10;
            position: relative;
        }

        /* --- INHALT --- */
        h1 { color: #ff6b6b; text-align: center; font-size: 2.5em; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        #story-content { font-size: 1.2em; line-height: 1.8; color: #555; transition: font-size 0.2s; }
        .hyphen-mode { text-align: justify; -webkit-hyphens: auto; -ms-hyphens: auto; hyphens: auto; }
        p { margin-bottom: 20px; }
        strong { color: #2c3e50; background-color: #fff3cd; padding: 0 4px; border-radius: 4px; }
        
        .story-image { display: block; margin: 20px auto 40px auto; width: 100%; max-width: 400px; height: auto; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); object-fit: contain; }
        .footer { margin-top: 60px; padding-top: 30px; border-top: 3px dashed #ffcc00; text-align: center; font-size: 1em; color: #888; }
        .footer a { color: #888; text-decoration: none; font-weight: bold; margin: 0 10px; }
        .footer a:hover { color: #ff6b6b; }
        .separator { color: #ffcc00; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <div class="toolbar">
            <button class="tool-btn" id="btnMagnify">üîç Lupe</button>
            <button class="tool-btn" id="btnSpeak">üîä Vorlesen</button>
            <button class="tool-btn" id="btnHyphen">‚úÇÔ∏è Silben</button>
            <button class="tool-btn" id="btnSmaller">üÖ∞Ô∏è -</button>
            <button class="tool-btn" id="btnBigger">üÖ∞Ô∏è +</button>
        </div>

        <div id="story-content" lang="de">
            
<h1>Das warme Geheimnis im Br√∂tchenbett</h1><img src="../bilder/das-warme-geheimnis-im-broetchenbett.png" onerror="this.onerror=null;this.src='https://rala84.github.io/lesekumpel/bilder/lesekumpel_logo.png';" class="story-image" alt="Geschichten Bild">

Stell dir vor, du h√§ltst etwas Warmes in deinen H√§nden. Es riecht so verlockend ‚Äì nach etwas Herzhaftem, aber auch ganz leicht nach weichem Brot. Ein runder Br√∂tchendeckel liegt da, so sanft wie eine frisch gebackene Wolke, und darauf tanzen winzige Sesamk√∂rner wie kleine, goldene Sternchen.

Darunter verbirgt sich eine Welt: saftiges, warmes Fleisch, und dar√ºber schmilzt K√§se wie eine goldene Decke. Ein knackiges Salatblatt lugt hervor, frisch und gr√ºn wie ein Fr√ºhlingsmorgen. Wenn du ganz vorsichtig hineinbei√üt... sp√ºrst du, wie alles zusammenkommt? Die weiche Br√∂tchenwolke, das w√ºrzige Herz, das frische Gr√ºn. Ein kleiner Augenblick Gl√ºck, der auf der Zunge zergeht.
        </div>
        
        <div class="footer">
            <p>Erstellt von deinem KI-Lesekumpel ü§ñ</p>
            <div style="margin-top: 10px;">
                <a href="https://rala84.app.n8n.cloud/form/30d75a75-54fd-42fd-bea6-ab24799ca565">‚ú® Neue Geschichte</a>
                <span class="separator">|</span>
                <a href="../index.html">üìö Zur Bibliothek</a>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const content = document.getElementById('story-content');
        let currentSize = 1.2;
        let isSpeaking = false;
        let isMagnifyMode = false;
        let textWrapped = false;

        // --- 1. DIE MAGIE: REKURSIVES VERPACKEN ---
        // Diese Funktion kriecht in jedes Element rein und verpackt nur den Text.
        function processNode(node) {
            // Wenn es ein Text-Knoten ist (Typ 3) und nicht leer
            if (node.nodeType === 3) {
                const text = node.nodeValue;
                if (!text.trim()) return; // Nur Leerzeichen √ºberspringen

                // Wir erstellen ein tempor√§res Element, um HTML zu bauen
                const tempSpan = document.createElement('span');
                
                // Jedes Wort wird in ein <span> eingewickelt.
                // Regex erkl√§rt: Finde Buchstaben/Zahlen, ersetze durch <span...>Wort</span>
                const newHTML = text.replace(/([a-zA-Z√§√∂√º√Ñ√ñ√ú√ü0-9]+)/g, '<span class="interactive-word">$1</span>');
                
                tempSpan.innerHTML = newHTML;
                
                // Wir ersetzen den alten Text-Knoten durch die neuen Nodes
                // Dazu nutzen wir ein DocumentFragment (bessere Performance)
                const fragment = document.createDocumentFragment();
                while (tempSpan.firstChild) {
                    fragment.appendChild(tempSpan.firstChild);
                }
                node.parentNode.replaceChild(fragment, node);
            } 
            else if (node.nodeType === 1) {
                // Wenn es ein Element ist (z.B. <p> oder <strong>), gehen wir tiefer rein
                // WICHTIG: Wir d√ºrfen nicht in Elemente gehen, die wir schon verpackt haben
                if (node.classList.contains('interactive-word') || node.tagName === 'SCRIPT' || node.tagName === 'STYLE') return;

                // R√ºckw√§rts loopen, da sich die NodeList √§ndern k√∂nnte (Sicherheitsnetz)
                for (let i = node.childNodes.length - 1; i >= 0; i--) {
                    processNode(node.childNodes[i]);
                }
            }
        }

        function activateMagnify() {
            if (textWrapped) return;
            console.log("Starte Text-Verpackung...");
            // Wir starten die Verarbeitung nur f√ºr Abs√§tze und Listen, nicht f√ºr √úberschriften h1
            const blocks = content.querySelectorAll('p, li');
            blocks.forEach(block => processNode(block));
            textWrapped = true;
            console.log("Text verpackt.");
        }


        // --- EVENT LISTENER ---

        // LUPE BUTTON
        document.getElementById('btnMagnify').addEventListener('click', function() {
            activateMagnify(); // Erst jetzt den Text umbauen
            
            this.classList.toggle('active');
            content.classList.toggle('magnify-mode');
            isMagnifyMode = content.classList.contains('magnify-mode');

            if (isMagnifyMode) {
                this.innerHTML = "üîç Klick ein Wort!";
                // Silbentrennung ausmachen, vertr√§gt sich nicht gut
                if (content.classList.contains('hyphen-mode')) document.getElementById('btnHyphen').click();
            } else {
                this.innerHTML = "üîç Lupe";
            }
        });

        // KLICK AUF WORT
        content.addEventListener('click', function(e) {
            if (!isMagnifyMode) return;
            
            // Wir pr√ºfen, ob das geklickte Element (oder sein Elternteil) ein Wort ist
            let target = e.target;
            if (!target.classList.contains('interactive-word')) return;

            // Reset alte Markierung
            document.querySelectorAll('.word-reading').forEach(el => el.classList.remove('word-reading'));
            
            // Neu markieren
            target.classList.add('word-reading');
            const wordText = target.innerText;

            // Vorlesen
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(wordText);
            utterance.lang = 'de-DE';
            utterance.rate = 0.8;
            
            utterance.onend = function() {
                target.classList.remove('word-reading');
            };
            
            window.speechSynthesis.speak(utterance);
        });


        // --- ANDERE BUTTONS (Standard Funktionen) ---

        // SCHRIFTGR√ñSSE
        document.getElementById('btnBigger').addEventListener('click', function() {
            if(currentSize < 3.0) { currentSize += 0.2; content.style.fontSize = currentSize + "em"; }
        });
        document.getElementById('btnSmaller').addEventListener('click', function() {
            if(currentSize > 0.8) { currentSize -= 0.2; content.style.fontSize = currentSize + "em"; }
        });

        // SILBENTRENNUNG
        document.getElementById('btnHyphen').addEventListener('click', function() {
            this.classList.toggle('active');
            content.classList.toggle('hyphen-mode');
            this.innerHTML = content.classList.contains('hyphen-mode') ? "‚úÇÔ∏è Trennung: AN" : "‚úÇÔ∏è Silben";
            if(isMagnifyMode && content.classList.contains('hyphen-mode')) document.getElementById('btnMagnify').click();
        });

        // VORLESEN (GANZ)
        document.getElementById('btnSpeak').addEventListener('click', function() {
            if (!('speechSynthesis' in window)) { alert("Geht leider nicht in diesem Browser."); return; }
            
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                this.innerHTML = "üîä Vorlesen";
                this.classList.remove('active');
            } else {
                if (isMagnifyMode) document.getElementById('btnMagnify').click();
                const text = content.innerText;
                const ut = new SpeechSynthesisUtterance(text);
                ut.lang = 'de-DE'; ut.rate = 0.9;
                
                ut.onend = () => { isSpeaking = false; this.innerHTML = "üîä Vorlesen"; this.classList.remove('active'); };
                window.speechSynthesis.speak(ut);
                isSpeaking = true;
                this.innerHTML = "‚èπÔ∏è Stoppen";
                this.classList.add('active');
            }
        });

        window.onbeforeunload = () => window.speechSynthesis.cancel();
    });
    </script>
</body>
</html>